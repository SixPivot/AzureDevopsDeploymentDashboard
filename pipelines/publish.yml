# Build and publish extension to Marketplace

trigger:
  branches:
    include:
      - main

steps:
  - checkout: self
    fetchDepth: 0

  - task: NodeTool@0
    displayName: "NodeTool"
    inputs:
      versionSpec: "16.x"

  - task: Npm@1
    displayName: "Npm: Install"
    inputs:
      command: ci
      workingDir: extension

  - script: |
      npx nbgv cloud --all-vars
    displayName: "Script: Set version"
    workingDirectory: extension

  - script: printenv
    displayName: "Script: printenv"

  - pwsh: |
      $config = (Get-Content configs/release.json) | ConvertFrom-Json
      $config | Add-Member -MemberType NoteProperty -Name version -Value $env:NBGV_NPMPACKAGEVERSION
      $config | ConvertTo-Json | Set-Content configs/release.json
    displayName: "PowerShell: Patch version"
    workingDirectory: extension

  - script: npm run package
    workingDirectory: extension

  - script: |
      npx tfx extension publish --token $(MARKETPLACE_TOKEN) --manifest-globs vss-extension.json --overrides-file configs/release.json --output-path out
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
    workingDirectory: extension
    displayName: 'Script: Publish to Marketplace'